## 1.TCP/IP协议漫游

### 1.1 TCP/IP议族体系结构、主要协议

#### 1.1.1数据链路层

实现网卡接口的网络驱动程序，用来处理数据在物理媒介的传播

##### ARP协议 Address Resolve Protocol 

在网络层用于将IP地址转为物理地址、才能使用数据链路层的服务

##### RARP协议 Reverse Address Resolve Protocol

网络上的无盘工作站，通过物理地址宣布发网络服务器查询自己的IP地址（提供RARP网络服务器一般存在）



**所有两个协议实现了IP地址和机器物理地址（一般为mac）的相互转换**

#### 1.1.2网络层

##### IP协议

**主要实现数据包的选路和转发**
WAN使用众多的分级路由来连接分散的主机和LAN
**主要任务：选择中间结点，确定两台主机之间的通信路径**
**网络层对上层协议隐藏了网络拓扑结构的连接细节，让上层以为通信双方直接相连**
IP通过逐跳的方式确定通信地址 **hop by hop**



##### ICMP Internet Control Message Protocol 因特网控制报文协议

IP的补充，检测网络连接。
eg 8位类型 8位代码 16位校验和

#### 1.1.3传输层

两台主机上的应用程序提供端到端（end to end）的通信

##### **TCP协议 Transmission Control Protocol 传输控制协议**

为应用层提供 **可靠 面向连接 基于流** 的服务。
**超时重传 数据确认**

**TCP通信双方，先建立TCP连接 并且必须在内核中为连接维持一些必要的数据结构 eg连接状态 读写缓冲 定时器**
**通信结束时双方必须关闭连接释放内核数据**

**基于流的数据没有边界限制，源源不断end to end。还可以逐个字节的写入读出**



**UDP协议 User Datagram Protocol 用户数据报协议**

**不可靠**
**无连接 每次发送数据都要指定接收端地址 即IP等信息** 
**基于数据报，即基于UDP的数据有最小长度，接收端必须以改长度为最小单位将其所有内容一次性读出**



#### 1.1.4应用层

**处理应用程序的逻辑。**

数据链路层、网络层、传输层负责处理网络通信的细节，在内核空间中实现。
应用层在用户空间实现，处理包括文件传输、名称查询和网络管理服务。

但是也有服务器程序在内核中实现，会提高效率 但实现复杂不灵活 不好移植 

##### 应用层协议

**ping**

应用程序、利用ICMP报文检测网络连接 是调试网络环境的必备工具

##### telnet

远程登陆协议 

##### OSPF （Open Shortest Path First 开放最短路径优先

动态路由更新协议 用于路由器间通信

##### DNS (Domain Name Service 域名服务

提供机器域名到 ip地址的转换

### 1.2封装 encapsulation

应用程序发送数据到物理网络之前，将沿着协议栈从上往下依次传递。每层协议都在上层数据的基础上加上自己的头部信息，可能会有尾部信息。

##### TCP段

经过TCP封装后的数据称为TCP报文段（TCP message segment），同时TCP头部信息和TCP内核缓冲区（发送或接受）数据一起构成了TCP报文段。

###### 发送细节

发送端应用程序使用send/write 向一个TCP连接写入数据，内核中的TCP模块（显然，TCP在内核中实现）先将数据复制到与该连接对应（说明内核中肯会建立多个TCP连接？）的TCP内核发送缓冲区中，然后TCP模块调用IP模块提供的服务，传递TCP头部信息和TCP发送缓冲区中的数据（TCP报文段）。



##### UDP段

基本与TCP一致。只是，每当UDP内核发送一个UDP数据报，本地副本就会被丢弃。如果应用程序没有得知接收端没收到，那么从新从用户空间拷贝UDP数据报到内核空间。



##### IP数据报

即IP模块对TCP/UDP进行封装得到的

##### 帧

经过数据链路层封装的数据称为帧 frame。
传输媒介不同，自然帧类型不同。以太网帧（ethernet frame）、令牌环帧（token ring frame）

帧最大传输单元 Max Transmit Unit MTU 帧最多能携带多少上层协议数据 ，受网络类型限制。



### 1.3分用 demultiplexing

帧通过数据链路层，到达目的主机时，会沿着协议栈自底向上依次传递。
如流水般进行，每层从中获取需要的信息，然后最终处理后的帧交给目标应用程序。

IP协议 ARP协议 RARP协议都使用**帧**传输数据	所以帧头部有用来区分的字段

ICMP TCP DCP协议都使用IP协议 因此**IP段**头部有用来区分的字段

**这样封装和分用似乎没发生过**



### 1.4ARP协议工作原理

**ARP可以实现任意网络层地址到物理层地址的转换**

**工作原理** ：

主机向所在网络广播一个ARP请求，这个请求包含目标机器的网络地址。网络中的所有机器都会收到这个请求，但只有被请求的目标会回应一个ARP应答，包含自己的物理地址。

#### 1.4.2 ARP高速缓存的查看和修改



## 2.IP协议详解

### 2.1IP服务特点

IP协议是TCP/IP协议族的动力，为上层提供无状态、无连接、不可靠的服务。

##### 无状态 stateless

IP通信双方不同步传输数据的状态信息，所有IP数据报的发送、传输和接收都是相互独立、没有上下文关系的。

**优点**: 简单 高效     即无需为保持通信的状态而分配一些内核资源,也无须每次传输数据都携带状态信息.

> 如HTTP UDP都是无状态协议 (连续两次的网页请求间没有关系)

**缺点**:无法处理乱序和重复的IP数据报

> 面向连接 比如TCP可以处理乱序重复的数据

##### 无连接 connectionless

IP通信双方不长久维持对方任何信息.因此,上层协议**每次**发送数据都要指定IP地址

##### 不可靠

IP协议不能保证IP数据报准确到达接收端 只是尽最大努力

> 发送失败的一些情况 :
>
> 1.中转路由器发现IP数据报在网络上存活的时间太长,他将丢失并返回一个ICMP错误消息给发送端
>
> 2.接收端发现收到的IP数据报不正确,他也将丢弃,并返回一个ICMP错误消息.
>
> **而且发送端发现IP数据报发送失败后,只是通知上层协议,并不会重新发送,由上层协议处理数据确认\超时重传等机制**

### 2.2IPV4头部结构

#### 利用tcpdump观察IPv4头部结构

**实验环境：**Windows subsystem Linux

**实验目的：**深入理解IPv4头部结构

**实验内容：**在测试机器yzx-computer上使用telnet登陆本机，利用tcpdump抓取这一过程中的telnet客户端和服务端之间交换的数据包。

```
sudo tcpdump -ntx -i lo #开启抓取本地回路数据包
telnet 127.0.0.1 18583     #开启另外一个终端执行telnet登陆本机
```

##### 实验结果分析：

```
IP 127.0.0.1.46442 > 127.0.0.1.18583: Flags [S], seq 3000263613, win 65495, options [mss 65495,sackOK,TS val 2817298392 ecr 0,nop,wscale 7], length 0
        0x0000:  4510 003c fcb4 4000 4006 3ff5 7f00 0001  
        0x0010:  7f00 0001 b56a 4897 b2d4 63bd 0000 0000
        0x0020:  a002 ffd7 fe30 0000 0204 ffd7 0402 080a
        0x0030:  a7ec 8fd8 0000 0000 0103 0307
```

客户端使用临时端口号46442，访问服务段18583端口。

length指定IP数据报携带的应用程序数据的长度。

显然IP数据报的长度是60字节。

| 十六进制    | 二进制   | IP头部信息                                                   |
| ----------- | -------- | ------------------------------------------------------------ |
| 0x4         | 0100     | 4位版本号 指定IP协议版本位IPv                                |
| 0x5         | 0101     | IP头部有多少给4字节 这里是20字节                             |
| 0x10        | 00010000 | 8位**服务类型** 3位优先权 4位TOS字段 1位保留字段             |
| 0x003c      | 00111100 | **数据报总长度**，最多六十字节                               |
| 0xfcb4      |          | 唯一**标识**主机发送的每一个数据报 初值由系统随机 每发送一个数据报，其值+1 |
| 0x4         | 010      | 三位标志字段 第一位保留 第二位设置禁止分片 第三位 表示更多分片 |
| 0x000       | 0        | 分片偏移 分片相对于原始IP数据报开始处的偏移                  |
| 0x40        | 01000000 | 八位生存时间 Time to live TTL数据报到达目的地之前允许通过的路由去跳数 |
| 0x06        | 00000110 | 区分上层协议 ICMP 1 TCP 6 UDP 17                             |
| 0x3ff7      |          | 头部校验和 header checksum 由发送端填充  接收端判断是否损坏  |
| 0x7ff000001 |          | 32位源IP地址                                                 |
| 0x7ff000001 |          | 32位目的端IP地址                                             |

### 2.3IP分片

IP数据报超过帧的最大传输单元MTU，将被分片传输。可以发生在发送端、中转路由器、传输过程，但只在最终的目标机器上，分片才会被内核中的IP模块重新组装。

##### IP头部主要信息

数据报标识：标识同一个数据报

标志：主机的标识

片偏移：用于最后的模块重装

> 以太网帧的MTU为1500字节，一次携带的IP数据报最多是1480（IP头部数据占据20）

每个IP分片都有自己的IP头部。

##### 分片区别

MF标志 偏移量

### 2.4IP路由

IP协议的一个核心任务是数据报路由，即决定发送数据报到目标机器的路径。

#### 2.4.1IP模块的工作流程

IP数据报应该发送至哪个下一跳路由或者目标机器，以及经过哪个网卡来发送，就是IP路由过程。

IP模块实现数据报路由的核心数据结构是路由表。路由表按照数据报的目标IP地址分类，同一类型的IP数据包被发送到相同的下一跳路由或者目标机器。

#### 2.4.2路由机制

路由表内容

| Destination | 目标网络 、主机                                      |
| ----------- | ---------------------------------------------------- |
| Gateway     | 网关地址，*或者0代表目标和本机在一个网络，不需要路由 |
| Genmask     | 网络掩码                                             |
| Flags       | 路由项标志                                           |
| Metric      | 路由距离，到达指定网络需要的中转数                   |
| Ref         | 路由项被引用次数                                     |
| Use         | 路由项被使用次数                                     |
| Iface       | 路由项对应的输出网卡接口                             |

##### 路由表如何分类？

> 1.查找路由表中和数据报里IP地址完全匹配的主机IP地址
>
> 2.查找路由表中和数据报里IP地址具有相同**网路ID**的网络IP地址
>
> 3.选择默认路由项，通常意味着数据报的下一跳是网关



#### 2.4.2路由更新

### 2.5IP转发

发送本机的IP数据报将由数据报转发子模块来处理。路由器执行数据报转发操作，主机一般只负责发送和接受，但实际上，主机可以通过修改/proc/sys/net/ipv4/ip_forward 内核参数为1，来使得主机能够进行数据报转发功能。

##### 数据报转发子模块工作流程

1.检查IP数据报头部的TTL值，若为0则丢弃。

2.查看数据报头部的严格源路由选择选项。若被设置，则检测数据报的目标IP地址是否为本机某个IP地址。若不是则发送一个ICMP源站选路失败报文给发送端。

3.可以给源端发送一个ICMP重定向报文，告诉一个更合理的下一跳路由。==（？？这是干啥嘞==



